---
title: "eNFI Lesson 2.1: Simple sampling for carbon - Design"
# output: word_document ## Uncomment for docx output and comment other outputs + runtime
output:
  learnr::tutorial:
    progressive: true
    allow_skip: false
    #css: css/style.css # To replace with in_header system.file() calls.
    includes:
      in_header:
        - !expr  system.file("tuto-helpers/css/custom.html", package = "eNFI")
        - !expr  system.file("tuto-helpers/css/fonts.html", package = "eNFI")
        - !expr  system.file("tuto-helpers/css/style.html", package = "eNFI")
        - !expr  system.file("tuto-helpers/css/banner-style.html", package = "eNFI")
        - !expr  system.file("tuto-helpers/css/toc-style.html", package = "eNFI")
        - html/header.html
runtime: shiny_prerendered
description: >
  Develop a systematic sampling design for carbon, based on forest cover areas and preliminary forest inventory. 
---

```{r setup, include=FALSE}

## Options
options(yaml.eval.expr = T)

knitr::opts_chunk$set(echo=F, message=F, warning=F)

## --- Spatial
library(sf)
library(units)
library(tmap)

## --- Data
library(eNFI)

## --- Data analysis
library(tidyverse)

## --- Style
library(ggspatial)
library(sysfonts)
library(showtext)

sysfonts::font_add("Lora", system.file("fonts/lora-v23-latin-italic.ttf", package = "eNFI", mustWork = T))
sysfonts::font_add("Shadow", system.file("fonts/shadows-into-light-v14-latin-regular.ttf", package = "eNFI", mustWork = T))
showtext::showtext_auto()


## Load data
load(system.file("extdata/louland_param.Rda", package = "eNFI"))
load(system.file("extdata/louland_lc.Rda", package = "eNFI"))
load(system.file("extdata/louland_admin.Rda", package = "eNFI"))
load(system.file("extdata/sf_exfi.Rda", package = "eNFI"))

## Load solutions
load(system.file("extdata/solutions-lesson1.Rda", package = "eNFI"))
#load(system.file("extdata/solutions-lesson21.Rda", package = "eNFI"))

## fixed profile - more profiles to be implemented in V2.0
## Rename tables
newland_name <- "Louland"

sf_lc    <- louland_lc
sf_admin <- louland_admin
pal      <- louland_param$hex
nb_ft <- 4

## Tutorial setup - Comment out to print docx for review
library(learnr)
library(gradethis)

tutorial_options(
  exercise.timelimit = 40,
  exercise.reveal_solution = FALSE
  )

gradethis_setup()


## For printing docx
# knitr::opts_chunk$set(error=TRUE)
# 
# grade_this_code <- function(x){return("")}
# grade_code      <- function(x){return("")}

```

## Welcome back!

<txt-green>This is the second lesson</txt-green> of the National Forest Inventory eLearning practice module.


###

<img src="images/lc-grid10-image.png" width="400" height="400" alt="Louland with a systematic sampling grid" align="right" style="margin: -1em 0 -1em 0"/>

This interactive module is designed to complement the National Forest Inventory eLearning Modules with practical, hands-on exercises. As you learned in lesson one, these exercises take place on a fictional island that just emerged in the middle of the Atlantic Ocean: `Louland`.

The practice module features interactive lessons designed to practice National Forest Inventory (NFI) sampling and the exploratory analysis of NFI field data with the [R programming language](www.r-project.com). Although this fictional land is not an official country, we will use the acronym NFI when referring to its forest inventory as the method and formulas applied here are valid for nationwide forest inventories.

Lesson 2 focuses on several sampling methods that we call "simple sampling" as they are based on the <txt-green>simple random sampling statistics</txt-green>. 



### Objectives 

As we have seen in the NFI eLearning Modules, NFIs are multi-purpose in nature, but the sampling design requires that we focus on one main variable of interest. In this lesson, <txt-green>the main variable of interest is the forest mean aboveground biomass</txt-green> of `r newland_name`. 

Here, we will limit ourselves to random and systematic sampling, and we will obtain aboveground biomass estimates for each forest type through post-stratification.


::::::{.infobox data-latex=""}

If you have not completed lesson 1: *Overview of the preliminary data*, we encourage you to start there. Lesson 1 provides a small overview of `r newland_name` and introduces how you will interact with the R consoles that are embedded in this document.

::::::

Lesson 2 is divided into two parts:

1. Sampling design
1. Data analysis

We will now bagin part 1. We will develop a <txt-green>sampling design</txt-green> for estimating the mean carbon stock of `r newland_name`'s forests in ton/ha. The objectives of part 1 are:

- Estimate sample size based on a precision/cost trade-off (cost being simplified to the number of plots that we can afford for now),
- Find a sampling grid size for a systematic sampling, closest to the estimated number of samples. 
- Create a simple random sampling with the same number of plots.
- Compare the distribution of plots per forest category for these two types of simple sampling designs.


::::::{.infobox data-latex=""}

Please note that nowadays many countries do not use these sampling design methods due to several inconveniences. These designs are often not optimal, as different sub-populations have different variability, and taking variability into consideration allows for more optimal designs (See module 3 on Sampling for more information).

However, since the calculations for the estimations resulting from these sampling methods are fairly simple, they constitute a good entry point to sampling and we will start from there. More advanced sampling design methods for NFI, *i.e.* stratified and ratio estimators, are the focus of other interactive lessons.

::::::


In this lesson, we will use the collection of packages grouped inside the package `tidyverse` for general data analysis and the package `sf` for spatial data analysis. We will also briefly use the package `units` to avoid confusion around area units.

```{r libs, eval=F}

library(tidyverse)
library(sf)
library(units)

```

Note that in the background we also use `extrafont` to add Google Fonts to our figures and `ggspatial` to add the North arrow and scale to our maps.

<txt-green>Let's get started!</txt-green>




## Sampling size

Remember in the third NFI eLearning Module, the formula to estimate the **sampling size**, `n`, based on Simple Random Sample (SRS), is:

$$n = \left(\frac{CV \cdot t^{1 - \alpha/2}_{n-1}}{A}\right)^2 \sim \left(\frac{CV \cdot 1.96}{A}\right)^2$$
with:

- $CV = s / \overline{y} \times 100$ the NFI main variable coefficient of variation expressed as percentage, 
- $s$ and $\overline{y}$ the samples main variable's standard deviation and average respectively,
- $A$ the desired precision in percentage, and 
- $t^{1 - \alpha/2}_{n-1}$ the Student's t-value with $n-1$ degrees of freedom and $1-\frac{\alpha}{2}$ confidence level where $\alpha$ is the significance level. This value is approximated by the value 1.96 when assuming an infinite sample and 0.95 confidence level (two tails $\alpha$ = 0.05).


###

Thanks to the results of the preliminary forest inventory (`exfi_agb`), we have an estimate of $\overline{y}$ and $s$ for a forest stand in ```r newland_name```. While this stand is most likely not representative of the whole island, we can use it to make an estimate of the number of samples necessary to achieve various target precision values. The final number of plots will depend on the desired precision and your budget constraints. In case of systematic sampling we can add an additional constraint: we want the NFI grid size in km to be an integer number (i.e. 1, 2, 3. etc.).

We looked at the table `exfi_agb` in Lesson 1, let's show it again to remind ourselves the inventory's mean aboveground biomass, `mean_agb`, and it's standard deviation, `sd_agb`. Print the table name in the console below.

```{r exfi, exercise=TRUE, exercise.lines=3}


```

```{r exfi-solution}
print(exfi_agb)
```

```{r exfi-check}
grade_this_code()
```

###

The table contains aggregated information on the number of trees measured, the average basal area (BA), in m^2^/ha, and aboveground biomass (AGB) in ton/ha. The aboveground biomass is associated with its confidence interval in ton/ha and in percentage.


```{r question1, echo=F}

question("What is the average aboveground biomass in ton/ha in the preliminary forest inventory?",
  answer("135", correct = TRUE),
  answer("303"),
  answer("115"),
  answer("53"),
  incorrect = "Incorrect, the average aboveground biomass is in the column mean_agb."
)

``` 


Back to calculating a sampling size, let's first calculate the number of samples for different precision levels. For a 5% precision, the number of samples is:

```{r n05}

n05 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb * 100) * 1.96 / 5)^2)

print(n05)

``` 


**Your turn, calculate `n10`, `n15` and `n20`, the number of samples necessary to get respectively 10%, 15% and 20% precision on ```r newland_name```'s mean aboveground biomass.**

Calculations for 10% here: 

```{r n10, exercise=TRUE, exercise.lines=6}

n10 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb) * ___ / ___)^2)


```

```{r n10-solution}

n10 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb * 100) * 1.96 / 10)^2)

```

```{r n10-check}

grade_this_code(print(n10))

```


Calculations for 15% here: 


```{r n15, exercise=TRUE, exercise.lines=6}

n15 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb) * ___ / ___)^2)


```

```{r n15-solution}

n15 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb * 100) * 1.96 / 15)^2)

```

```{r n15-check}

grade_this_code(print(n15))

```

  

Calculations for 20% here: 


```{r n20, exercise=TRUE, exercise.lines=6}

n20 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb) * ___ / ___)^2)


```

```{r n20-solution}

n20 <- round(((exfi_agb$sd_agb / exfi_agb$mean_agb * 100) * 1.96 / 20)^2)

```

```{r n20-check}

grade_this_code(print(n20))

```



###

Well done! **We have enough to budget for approximately 300 plots**. 

```{r question2, echo=F}

question("What precision can we afford?",
  answer("5%"),
  answer("10%", correct = TRUE),
  answer("15%"),
  answer("20%"),
  incorrect = "Incorrect, look again at the numnber of plots given for different precision targets."
)

``` 



